---
title: "Indice de Reclutamiento  Erizo X y XI regiones "
subtitle: "Análisis complementario Seguimiento Bentónico 1996-2022"
author: "Mauricio Mardones. Inv. Depto Ev. Recursos. IFOP"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
toc: true
toc-title: "Tabla de Contenidos"
format:
  html:
    theme: cosmo
    fontsize: 0.9em
    linestretch: 1.7
    html-math-method: katex
    self-contained: true
    embed-resources: true
    code-tools: true
#bibliography: reineta.bib
#csl: apa.csl
#link-citations: yes
#linkcolor: blue
---


### Set de trabajo y librerías utilizadas

```{r setup}
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE,
                      fig.path="Figuras/")
```


```{r Xquarz_bug}
options(bitmapType = "cairo") 
#XQuartz is a mess, put this in your onload to default to cairo instead (https://github.com/tidyverse/ggplot2/issues/2655)
# Lo mapas se hacen mas rapido
# solo para IOs
```


```{r error=F}
library(GGally)
library(knitr)
library(tidyverse)
library(patchwork)
library(marmap)
library(mapproj)
library(maps)
library(raster)
library(knitr)
library(ggrepel)
library(sf)
library(ggthemes) # nuevos fondos
library(readxl)
library(performance)
library(ggridges)
library(see)
```




### Tallas estaciones fijas

```{r}

EstFij <- read_csv2("~/IFOP/Erizo_SA/2019/Bancos 2018/Talla_EstFi_20011_2018.csv")
EstFij2 <- as.data.frame(EstFij)
```


```{r message=FALSE, warning=FALSE}
jz3 <- ggplot(EstFij2 %>% 
                drop_na(), aes(x=talla_mm, y = as.factor(year), 
                      fill = factor(stat(quantile))))+
  stat_density_ridges(
    geom = "density_ridges_gradient",
    calc_ecdf = TRUE,
     quantiles = c(0.10, 0.90)) +
  scale_fill_manual(
    name = "Probabilidad", values = c("#de2d26", "#fee0d2", "#de2d26"),
    labels = c("[0, 0.10]", "[0.10, 0.90]", "[0.90, 1]"))+
  facet_wrap(.~sector, ncol=8) +   
  geom_vline(xintercept = 65, color = "red")+
  scale_x_continuous(breaks = seq(from = 40, to = 120, by = 10))+
  scale_y_discrete(breaks = seq(from = 1996, to = 2022, by = 5))+
  #scale_fill_viridis_d(name="SubArea")+
  theme_few()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  xlim(10,120)+
  xlab("Longitud (cm.)")+
  ylab("")
jz3
```
Lo mismo por poligono

```{r, message=FALSE, warning=FALSE}
jz4 <- ggplot(EstFij2 %>% 
                drop_na(), aes(x=talla_mm, y = as.factor(year), 
                      fill = factor(stat(quantile))))+
  stat_density_ridges(
    geom = "density_ridges_gradient",
    calc_ecdf = TRUE,
    quantiles = c(0.10, 0.90),
    jittered_points = TRUE,
    alpha=0.1) +
  scale_fill_manual(
    name = "Probabilidad", values = c("#de2d26", "#fee0d2", "#de2d26"),
    labels = c("[0, 0.10]", "[0.10, 0.90]", "[0.90, 1]"))+
  facet_wrap(.~poligono, ncol=5) +   
  geom_vline(xintercept = 65, color = "red")+
  scale_x_continuous(breaks = seq(from = 40, to = 120, by = 10))+
  scale_y_discrete(breaks = seq(from = 1996, to = 2022, by = 5))+
  #scale_fill_viridis_d(name="SubArea")+
  theme_few()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  xlim(10,120)+
  xlab("Longitud (cm.)")+
  ylab("")
jz4
```
Lo mismo por zona

```{r message=FALSE, warning=FALSE}
jz5 <- ggplot(EstFij2 %>% 
                drop_na(), aes(x=talla_mm, y = as.factor(year), 
                      fill = factor(stat(quantile))))+
  stat_density_ridges(
    geom = "density_ridges_gradient",
    calc_ecdf = TRUE,
    quantiles = c(0.10, 0.90),
    jittered_points = TRUE,
    alpha=0.1,
    rel_min_height = 0.05) +
  scale_fill_manual(
    name = "Probabilidad", values = c("#de2d26", "#fee0d2", "#de2d26"),
    labels = c("[0, 0.10]", "[0.10, 0.90]", "[0.90, 1]"))+
  facet_wrap(.~macrozona, ncol=3) +   
  geom_vline(xintercept = 65, color = "red")+
  scale_x_continuous(breaks = seq(from = 40, to = 120, by = 10))+
  scale_y_discrete(breaks = seq(from = 1996, to = 2022, by = 1))+
  #scale_fill_viridis_d(name="SubArea")+
  theme_few()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  xlim(10,120)+
  xlab("Longitud (cm.)")+
  ylab("")
jz5
```
Calculo cuantiles por grupo

```{r}
# Calcular cuantiles por grupo
cuantiles_por_zona <- tapply(EstFij2$talla_mm, 
                              EstFij2$macrozona,
                              function(x) quantile(x, c(0.10, 0.5, 0.90)))
cuantiles_por_poligono <- tapply(EstFij2$talla_mm, 
                              EstFij2$poligono,
                              function(x) quantile(x, c(0.10, 0.5, 0.90)))
cuantiles_por_año <- tapply(EstFij2$talla_mm, 
                              EstFij2$year,
                              function(x) quantile(x, c(0.10, 0.5, 0.90)))

print(cuantiles_por_zona)
print(cuantiles_por_poligono)
print(cuantiles_por_año)
```



Una vez definidos los quantiles de los muestreos poblacionales (Estaciones Fijas), se identifica que valores de entre `54 y 46 mm ` son identificados como un porcentaje de ingreso a la fraccion eplotable. 

Calcuo el promedio del cuantil `90` por zona.

```{r}
mean(54, 38, 46)
```

# Indice Reclutamiento

### Tallas Seguimiento

```{r}
load("talla2022.Rdata")
```


```{r warning=FALSE}
talla2022exp <- talla2022 %>% 
  drop_na() %>% 
  type.convert(as.is = TRUE) %>% 
  uncount(FRECUENCIA)

colSums(is.na(talla2022exp))
```

```{r message=FALSE, warning=FALSE}
tallasegpo <- ggplot(talla2022exp %>% 
                drop_na(), aes(x=LONGITUD, y = as.factor(ANO_ARR), 
                      fill = factor(stat(quantile))))+
  stat_density_ridges(
    geom = "density_ridges_gradient",
    calc_ecdf = TRUE,
     quantiles = c(0.10, 0.90)) +
  scale_fill_manual(
    name = "Probabilidad", values = c("#3182bd", "#deebf7", "#3182bd"),
    labels = c("[0, 0.10]", "[0.10, 0.90]", "[0.90, 1]"))+
  facet_wrap(.~POLIGONO, ncol=6) +   
  geom_vline(xintercept = 65, color = "red")+
  scale_x_continuous(breaks = seq(from = 40, to = 120, by = 10))+
  scale_y_discrete(breaks = seq(from = 1996, to = 2022, by = 5))+
  #scale_fill_viridis_d(name="SubArea")+
  theme_few()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  xlim(10,120)+
  xlab("Longitud (cm.)")+
  ylab("")
tallasegpo
```


El promedio de un 10% de los quantiles de entrada a la fracción explotable es de `56 mm`.

Ahora identifico los distintos cuantiles de los datos de pesquería y estaciones

```{r warning=FALSE}
cuantil_10pesq <- quantile(talla2022exp$LONGITUD, 0.10)
cuantil_10est <- quantile(EstFij2$talla_mm, 0.90)
```


```{r warning=FALSE}
indice_reclutamiento <- talla2022exp %>%
  filter(LONGITUD<cuantil_10est) %>% 
  group_by(ANO_ARR, MES_ARR, POLIGONO, ZONA, POLIGONO_IFOP) %>%
  summarize(PROP = n() / nrow(talla2022exp)) %>% 
  mutate(PROPLOG =log(PROP))
# Crear gráficos en facet_wrap de barras para representar el índice de reclutamiento
```
Veo los datos crudos  con la linea como media del cuantil de los datos
```{r warning=FALSE}
indseg <- ggplot(indice_reclutamiento , 
       aes(x = factor(ANO_ARR), 
           y = PROP)) +
  geom_boxplot() +
  facet_wrap(POLIGONO~., ncol=4) +
  scale_x_discrete(breaks = seq(from = 1996, to = 2022, by = 4))+
  theme_few()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))+
   labs(x = "ANO", 
        y = "Índice de Reclutamiento")+
  ylim(0, 0.001)
indseg
```

Veo los datos normalizados con la linea como media del cuantil de los datos
```{r warning=FALSE}
indseg2 <- ggplot(indice_reclutamiento , 
       aes(x = factor(ANO_ARR), 
           y = PROPLOG)) +
  geom_boxplot() +
  facet_wrap(POLIGONO~., ncol=4) +
  geom_hline(yintercept = quantile(indice_reclutamiento$PROPLOG, 0.5), 
             color = "blue")+
  scale_x_discrete(breaks = seq(from = 1996, to = 2022, by = 4))+
  theme_few()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
   labs(x = "ANO", 
        y = "Índice de Reclutamiento")
indseg2
```

ahora estandarizo los datos entre -1 y 1.

```{r warning=FALSE}
a <- -1  # Límite inferior del rango objetivo
b <- 1   # Límite superior del rango objetivo

# Calcular el valor mínimo y máximo de tus datos
min_x <- min(indice_reclutamiento$PROPLOG)
max_x <- max(indice_reclutamiento$PROPLOG)

# Aplicar la fórmula de normalización
indice_reclutamiento$PROPLOG2 <- ((indice_reclutamiento$PROPLOG- min_x) / (max_x - min_x)) * (b - a) + a
```


```{r warning=FALSE, message=FALSE}
indseg3 <- ggplot(indice_reclutamiento  %>% 
  group_by(ANO_ARR,POLIGONO) %>%
  summarise(PROPLOG3=mean(PROPLOG2)), 
       aes(x = factor(ANO_ARR), 
           y = PROPLOG3,
           fill=PROPLOG3 > 0)) +
  geom_bar(stat = "identity")  +
  scale_fill_manual(values = c("black", "red"),
                    labels = c("Negativo", "Positivo"),
                    name="IR Erizo") +
  facet_wrap(.~POLIGONO) +
  geom_hline(yintercept = 0, color = "red")+
  scale_x_discrete(breaks = seq(from = 1996, to = 2022, by = 4))+
  theme_few()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  labs(x = "ANO", 
        y = "Índice de Reclutamiento")+
  coord_flip()
indseg3


```

Grafico como Oscilación por ppoligono

```{r}
recosc <- ggplot(indice_reclutamiento %>% 
                     group_by(ANO_ARR, POLIGONO, ZONA ) %>%
                    summarise(PROPLOG3=mean(PROPLOG2)), 
       aes(x = ANO_ARR, y = PROPLOG3)) +
  geom_ribbon(aes(ymin = pmax(PROPLOG3, 0), 
                  ymax = 0), 
              fill = "#de2d26", 
              alpha = 0.8) +  # Área por encima de la línea
  geom_ribbon(aes(ymin = pmin(PROPLOG3, 0), 
                  ymax = 0), 
              fill = "black", 
              alpha = 0.8) +  # Área por debajo de la línea
  geom_hline(yintercept = 0, color = "red")+
  geom_line(color = "black") +  # Línea de anomalías
  geom_point( alpha=0.2,
              size= 0.9)+
  labs(x = "AÑO", y = "Indice Reclutamiento Erizo") +
   facet_wrap(.~POLIGONO, ncol = 4)+
  theme_few()+
  theme(axis.text.x = element_text(angle = 90, hjust = 2))
recosc

```

Grafico como Oscilación por Zona

```{r message=F, warning=F}
recosczo <- ggplot(indice_reclutamiento %>% 
                     group_by(ANO_ARR, ZONA, MES_ARR ) %>%
                    summarise(PROPLOG3=mean(PROPLOG2)), 
       aes(x = ANO_ARR, y = PROPLOG3)) +
  geom_ribbon(aes(ymin = pmax(PROPLOG3, 0), 
                  ymax = 0), 
              fill = "#31a354", 
              alpha = 0.5) +  # Área por encima de la línea
  geom_ribbon(aes(ymin = pmin(PROPLOG3, 0), 
                  ymax = 0), 
              fill = "#bdbdbd", 
              alpha = 0.5) +  # Área por debajo de la línea
  geom_hline(yintercept = 0, color = "red")+
  geom_line(color = "black") +  # Línea de anomalías
  geom_point( alpha=0.2,
              size= 0.9)+
  labs(x = "AÑO", y = "Indice Reclutamiento Erizo") +
   facet_grid(MES_ARR~ZONA)+
  theme_few()+
  theme(axis.text.x = element_text(angle = 90, hjust = 2))
recosczo

```






# Indicadores:

  - Seguimiento y evaluación:
  Tallas medias por macrozona y poligono
  Indice  de Reclutamiento por macrozona y poligono y por mes
  CPUE por poligono y por procedencia
  biomasa desovante por macrozona
  F por macrozona
  
  - Red Estaciones fijas
  Tallas medias
  Cobertura algal
  Densidades medias por sector por macrozona
  
  